<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>摂取カロリー記録アプリ</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Kosugi Maru', sans-serif;
    background: #fff0f0;
    color: #6b2b2b;
    padding: 20px;
    margin: 0;
  }
  h1 {
    color: #d43c54;
    margin-bottom: 10px;
    position: relative;
  }

  /* カレンダー表示ボタン */
  .calendar-button {
    position: absolute;
    top: 20px;
    right: 20px;
  }

  /* 入力フォーム全体 */
  form.input-form {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, auto);
    gap: 14px 20px;
    margin-top: 50px; /* タイトルの下に余裕を */
    max-width: 480px;
  }
  .input-group {
    display: flex;
    flex-direction: column;
  }
  .input-group label {
    font-weight: bold;
    margin-bottom: 6px;
    color: #b71c1c; /* 濃い赤 */
    font-size: 14px;
  }
  .input-group input,
  .input-group select {
    padding: 8px 10px;
    font-size: 16px;
    border: 2px solid #f8bbd0; /* 薄ピンク */
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
    transition: border-color 0.3s ease;
  }
  .input-group input:focus,
  .input-group select:focus {
    border-color: #ef6c00; /* オレンジ */
    outline: none;
  }

  /* 記録追加ボタン */
  button#addEntryBtn {
    grid-column: span 2;
    margin-top: 8px;
    background: linear-gradient(45deg, #ef5350, #f48fb1);
    border: none;
    color: white;
    font-weight: bold;
    font-size: 16px;
    padding: 10px 0;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 3px 6px rgba(244, 143, 177, 0.6);
    transition: background 0.3s ease;
  }
  button#addEntryBtn:hover {
    background: linear-gradient(45deg, #d32f2f, #f06292);
  }

  /* カレンダー＆全削除ボタン行 */
  .button-row {
    max-width: 480px;
    margin: 15px 0 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  button#clearAllBtn {
    background: linear-gradient(45deg, #fb8c00, #ffb74d);
    border: none;
    border-radius: 10px;
    padding: 10px 18px;
    font-size: 15px;
    color: #4e342e;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 6px rgba(255, 183, 77, 0.6);
    transition: background 0.3s ease;
  }
  button#clearAllBtn:hover {
    background: linear-gradient(45deg, #ef6c00, #ffa726);
  }
  button#openRegisterBtn {
    background: linear-gradient(45deg, #ef5350, #f48fb1);
    border: none;
    border-radius: 10px;
    padding: 10px 18px;
    font-size: 15px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 6px rgba(244, 143, 177, 0.6);
    transition: background 0.3s ease;
  }
  button#openRegisterBtn:hover {
    background: linear-gradient(45deg, #d32f2f, #f06292);
  }

  /* テーブル */
  table {
    width: 100%;
    max-width: 480px;
    border-collapse: collapse;
    background: #fff0f5;
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    border: 1px solid #f8bbd0;
    padding: 10px;
    text-align: center;
    font-size: 14px;
    color: #6b2b2b;
  }
  th {
    background: #f48fb1;
    color: white;
  }

  /* 合計表示 */
  #totalCalories {
    max-width: 480px;
    margin: 12px 0 30px;
    font-size: 18px;
    font-weight: bold;
    color: #b71c1c;
  }

  /* モーダル */
  .modal {
    display: none;
    position: fixed;
    z-index: 99;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(150, 100, 120, 0.6);
    backdrop-filter: blur(4px);
  }
  .modal-content {
    background: #fff0f5;
    margin: 5% auto;
    padding: 25px;
    border-radius: 12px;
    width: 90%;
    max-width: 460px;
    box-shadow: 0 0 15px rgba(244, 143, 177, 0.8);
    position: relative;
  }
  .close {
    position: absolute;
    right: 18px;
    top: 14px;
    font-size: 26px;
    font-weight: bold;
    color: #b71c1c;
    cursor: pointer;
  }

  /* 登録済み食品リスト */
  #foodListDisplay li {
    margin-bottom: 8px;
    font-size: 15px;
    color: #6b2b2b;
  }
  #foodListDisplay button {
    margin-left: 12px;
    background: #f48fb1;
    border: none;
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 13px;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #foodListDisplay button:hover {
    background: #d32f2f;
  }
</style>
</head>
<body>

<h1>
  摂取カロリー記録
  <button class="calendar-button btn" onclick="openCalendarModal()" aria-label="カレンダー表示ボタン" title="カレンダー表示">📅</button>
</h1>

<form class="input-form" onsubmit="event.preventDefault(); addEntry();">
  <div class="input-group">
    <label for="calendarDate">日付</label>
    <input type="date" id="calendarDate" required />
  </div>
  <div class="input-group">
    <label for="timeSelect">時間</label>
    <select id="timeSelect" required>
      <option value="朝食">朝食</option>
      <option value="昼食">昼食</option>
      <option value="夕食">夕食</option>
      <option value="間食">間食</option>
    </select>
  </div>
  <div class="input-group">
    <label for="foodSelect">食品</label>
    <select id="foodSelect" required></select>
  </div>
  <div class="input-group">
    <label for="quantity">数量</label>
    <select id="quantity" required></select>
  </div>
  <button id="addEntryBtn" type="submit">記録を追加</button>
</form>

<div class="button-row">
  <button id="clearAllBtn" type="button" onclick="clearAll()">すべて削除</button>
  <button id="openRegisterBtn" type="button" onclick="openRegisterModal()">食品データ登録へ</button>
</div>

<table>
  <thead>
    <tr>
      <th>時間</th>
      <th>食品名</th>
      <th>数量</th>
      <th>カロリー</th>
    </tr>
  </thead>
  <tbody id="entryTableBody"></tbody>
</table>

<div id="totalCalories">合計: 0 kcal</div>

<!-- 食品データ登録モーダル -->
<div id="registerModal" class="modal" aria-hidden="true" aria-labelledby="registerTitle" role="dialog">
  <div class="modal-content">
    <span class="close" onclick="closeRegisterModal()" aria-label="閉じる">&times;</span>
    <h2 id="registerTitle" style="color:#b71c1c;">食品データ登録</h2>
    <form id="foodRegisterForm" onsubmit="event.preventDefault(); addFoodData();">
      <div class="input-group">
        <label for="foodNameInput">食品名</label>
        <input type="text" id="foodNameInput" required />
      </div>
      <div class="input-group">
        <label for="foodCalorieInput">カロリー (1単位あたり)</label>
        <input type="number" id="foodCalorieInput" min="1" required />
      </div>
      <button class="btn btn-primary" type="submit" style="margin-top: 12px;">登録</button>
    </form>
  </div>
</div>

<!-- カレンダーモーダル -->
<div id="calendarModal" class="modal" aria-hidden="true" aria-labelledby="calendarTitle" role="dialog">
  <div class="modal-content">
    <span class="close" onclick="closeCalendarModal()" aria-label="閉じる">&times;</span>
    <h2 id="calendarTitle" style="color:#b71c1c;">カレンダーで記録確認</h2>
    <div id="calendarContainer" style="overflow-x:auto;">
      <!-- カレンダーをここに生成 -->
    </div>
  </div>
</div>

<script>
  // --- データ初期化 ---
  let foodData = JSON.parse(localStorage.getItem('foodData') || '[]');
  let entries = JSON.parse(localStorage.getItem('entries') || '[]');

  // --- 画面ロード時 ---
  window.onload = function() {
    populateFoodSelect();
    populateQuantitySelect();
    renderEntries();
  };

  // 食品選択肢を作成
  function populateFoodSelect() {
    const foodSelect = document.getElementById('foodSelect');
    foodSelect.innerHTML = '';
    if (foodData.length === 0) {
      foodSelect.innerHTML = '<option disabled>登録された食品がありません</option>';
      return;
    }
    foodData.forEach(food => {
      const opt = document.createElement('option');
      opt.value = food.name;
      opt.textContent = food.name + ' (' + food.calorie + ' kcal/単位)';
      foodSelect.appendChild(opt);
    });
  }

  // 数量選択肢を作成 (1～10)
  function populateQuantitySelect() {
    const quantitySelect = document.getElementById('quantity');
    quantitySelect.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      quantitySelect.appendChild(opt);
    }
  }

  // 記録を追加
  function addEntry() {
    const date = document.getElementById('calendarDate').value;
    const time = document.getElementById('timeSelect').value;
    const foodName = document.getElementById('foodSelect').value;
    const quantity = Number(document.getElementById('quantity').value);

    if (!date || !time || !foodName || !quantity) {
      alert('すべての項目を入力してください');
      return;
    }

    const food = foodData.find(f => f.name === foodName);
    if (!food) {
      alert('選択された食品データが見つかりません');
      return;
    }
    const calorie = food.calorie * quantity;

    entries.push({ date, time, foodName, quantity, calorie });
    localStorage.setItem('entries', JSON.stringify(entries));

    renderEntries();
    resetInputFields();
  }

  // 入力欄リセット
  function resetInputFields() {
    document.getElementById('calendarDate').value = '';
    document.getElementById('timeSelect').selectedIndex = 0;
    if (foodData.length > 0) document.getElementById('foodSelect').selectedIndex = 0;
    document.getElementById('quantity').selectedIndex = 0;
  }

  // 記録表示
  function renderEntries() {
    const tbody = document.getElementById('entryTableBody');
    tbody.innerHTML = '';

    // 今日の日付の記録のみ表示（任意で変更可）
    const today = new Date().toISOString().slice(0, 10);

    let total = 0;
    entries.forEach(entry => {
      // 今は全件表示
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.time}</td>
        <td>${entry.foodName}</td>
        <td>${entry.quantity}</td>
        <td>${entry.calorie.toLocaleString()} kcal</td>
      `;
      tbody.appendChild(tr);
      total += entry.calorie;
    });
    document.getElementById('totalCalories').textContent = '合計: ' + total.toLocaleString() + ' kcal';
  }

  // 全削除
  function clearAll() {
    if (confirm('全ての記録を削除しますか？')) {
      entries = [];
      localStorage.setItem('entries', JSON.stringify(entries));
      renderEntries();
    }
  }

  // 食品データ登録モーダル制御
  const registerModal = document.getElementById('registerModal');
  function openRegisterModal() {
    registerModal.style.display = 'block';
    registerModal.setAttribute('aria-hidden', 'false');
    document.getElementById('foodNameInput').focus();
  }
  function closeRegisterModal() {
    registerModal.style.display = 'none';
    registerModal.setAttribute('aria-hidden', 'true');
  }

  // 食品データ登録
  function addFoodData() {
    const name = document.getElementById('foodNameInput').value.trim();
    const calorie = Number(document.getElementById('foodCalorieInput').value);
    if (!name || !calorie || calorie <= 0) {
      alert('正しい食品名とカロリーを入力してください');
      return;
    }
    if (foodData.some(f => f.name === name)) {
      alert('同じ名前の食品が既に登録されています');
      return;
    }
    foodData.push({ name, calorie });
    localStorage.setItem('foodData', JSON.stringify(foodData));
    populateFoodSelect();
    closeRegisterModal();
    document.getElementById('foodRegisterForm').reset();
  }

  // カレンダーモーダル制御
  const calendarModal = document.getElementById('calendarModal');
  function openCalendarModal() {
    calendarModal.style.display = 'block';
    calendarModal.setAttribute('aria-hidden', 'false');
    renderCalendar();
  }
  function closeCalendarModal() {
    calendarModal.style.display = 'none';
    calendarModal.setAttribute('aria-hidden', 'true');
  }

  // カレンダー表示用関数（簡易版）
  function renderCalendar() {
    const container = document.getElementById('calendarContainer');
    container.innerHTML = '';

    // 月初と月末を決定（今月）
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();

    // カレンダー用テーブル作成
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';

    // ヘッダー行（曜日）
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    ['日', '月', '火', '水', '木', '金', '土'].forEach(dayName => {
      const th = document.createElement('th');
      th.textContent = dayName;
      th.style.border = '1px solid #f48fb1';
      th.style.padding = '6px';
      th.style.backgroundColor = '#f8bbd0';
      th.style.color = '#b71c1c';
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // ボディ
    const tbody = document.createElement('tbody');
    let tr = document.createElement('tr');
    let dayOfWeek = firstDay.getDay();

    // 空セル埋め
    for (let i = 0; i < dayOfWeek; i++) {
      const td = document.createElement('td');
      td.style.border = '1px solid #f48fb1';
      td.style.padding = '8px';
      tr.appendChild(td);
    }

    // 日付セル作成
    for (let day = 1; day <= daysInMonth; day++) {
      if (dayOfWeek === 7) {
        tbody.appendChild(tr);
        tr = document.createElement('tr');
        dayOfWeek = 0;
      }
      const td = document.createElement('td');
      td.style.border = '1px solid #f48fb1';
      td.style.padding = '6px';
      td.style.verticalAlign = 'top';
      td.style.height = '80px';
      td.style.fontSize = '14px';
      td.style.position = 'relative';

      const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      // 日付表示
      const dayLabel = document.createElement('div');
      dayLabel.textContent = day;
      dayLabel.style.fontWeight = 'bold';
      dayLabel.style.color = '#b71c1c';
      td.appendChild(dayLabel);

      // その日の合計カロリー表示
      const calSum = entries
        .filter(e => e.date === dateStr)
        .reduce((sum, e) => sum + e.calorie, 0);
      if (calSum > 0) {
        const calLabel = document.createElement('div');
        calLabel.textContent = `${calSum} kcal`;
        calLabel.style.color = '#ef6c00';
        calLabel.style.fontSize = '12px';
        calLabel.style.marginTop = '6px';
        td.appendChild(calLabel);
      }

      tr.appendChild(td);
      dayOfWeek++;
    }

    // 最終週の空セル埋め
    while (dayOfWeek > 0 && dayOfWeek < 7) {
      const td = document.createElement('td');
      td.style.border = '1px solid #f48fb1';
      td.style.padding = '8px';
      tr.appendChild(td);
      dayOfWeek++;
    }

    tbody.appendChild(tr);
    table.appendChild(tbody);
    container.appendChild(table);
  }
</script>

</body>
</html>
