<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>摂取カロリー記録アプリ</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Kosugi Maru', sans-serif;
    padding: 20px;
    background: #fff5f8;
    color: #4b2e2e;
  }
  h1, h2, h3 {
    color: #d36b8b;
  }

  /* ヘッダーとカレンダーボタン */
  #header {
    position: relative;
    display: inline-block;
    margin-bottom: 20px;
  }
  #header h1 {
    margin: 0;
  }
  #calendarBtn {
    position: absolute;
    bottom: 0;
    right: 0;
    font-size: 0.8em;
    padding: 4px 10px;
    background: #ffcad4;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: #4b2e2e;
  }
  #calendarBtn:hover {
    background: #fbb5c4;
  }

  /* 入力フォーム2列2行レイアウト */
  #inputForm {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto auto;
    gap: 10px 15px;
    max-width: 440px;
    margin-bottom: 20px;
  }
  #inputForm input,
  #inputForm select,
  #inputForm button {
    width: 100%;
    box-sizing: border-box;
    padding: 8px;
    border-radius: 10px;
    border: 1px solid #e0b7b7;
    font-size: 16px;
  }
  #inputForm button {
    background: #ffcad4;
    border: none;
    border-radius: 12px;
    box-shadow: 1px 2px 4px rgba(0,0,0,0.1);
    color: #4b2e2e;
    font-weight: bold;
    cursor: pointer;
  }
  #inputForm button:hover {
    background: #fbb5c4;
  }
  /* ボタンは横並びに */
  #buttonWrap {
    grid-column: span 2;
    display: flex;
    gap: 10px;
  }
  #buttonWrap button {
    flex: 1;
  }

  /* 記録テーブル */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    border: 1px solid #f4c2c2;
    padding: 10px;
    text-align: center;
  }
  th {
    background: #ffe3e3;
    color: #4b2e2e;
  }

  /* 合計表示 */
  .summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
  }

  /* モーダル共通 */
  .modal {
    display: none;
    position: fixed;
    z-index: 10;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
    background-color: #fff0f5;
    margin: 8% auto;
    padding: 20px;
    border: 1px solid #f0c0c0;
    width: 90%;
    max-width: 480px;
    border-radius: 10px;
    position: relative;
  }
  .close {
    color: #aaa;
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 26px;
    font-weight: bold;
    cursor: pointer;
  }
  .close:hover {
    color: #d36b8b;
  }

  /* カレンダーモーダルのカレンダー部分 */
  #calendarDisplay {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }
  #calendarDisplay div {
    padding: 6px 4px;
    text-align: center;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
  }
  #calendarDisplay .header {
    font-weight: bold;
    background: #ffd3e2;
  }
  #calendarDisplay .date-cell {
    background: #fff0f5;
    border: 1px solid #f4c2c2;
    position: relative;
  }
  #calendarDisplay .date-cell:hover {
    background: #ffcad4;
  }
  #calendarDisplay .date-cell.today {
    border: 2px solid #d36b8b;
  }
  #calendarDisplay .date-cell.has-entry::after {
    content: attr(data-kcal) " kcal";
    position: absolute;
    bottom: 4px;
    right: 4px;
    font-size: 10px;
    color: #d36b8b;
    font-weight: bold;
  }
  #calendarDisplay .empty-cell {
    background: transparent;
    border: none;
    cursor: default;
  }

  /* フード登録モーダル内 */
  #registerModal label {
    display: block;
    margin-bottom: 10px;
  }
  #registerModal input {
    width: 100%;
    padding: 6px 8px;
    margin-top: 4px;
    border-radius: 8px;
    border: 1px solid #e0b7b7;
    font-size: 16px;
  }
  #foodListDisplay {
    max-height: 150px;
    overflow-y: auto;
    padding-left: 16px;
  }
  #foodListDisplay li {
    margin-bottom: 6px;
  }
  #foodListDisplay button {
    margin-left: 10px;
    background: #ff7f7f;
    border: none;
    border-radius: 8px;
    padding: 2px 6px;
    cursor: pointer;
    color: white;
    font-size: 14px;
  }
  #foodListDisplay button:hover {
    background: #f45555;
  }

  @media (max-width: 480px) {
    #inputForm {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto auto auto;
    }
    #buttonWrap {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
  <div id="header">
    <h1>摂取カロリー記録</h1>
    <button id="calendarBtn" onclick="openCalendarModal()">カレンダー表示</button>
  </div>

  <div id="inputForm">
    <input type="date" id="calendarDate" />
    <select id="timeSelect" aria-label="時間帯">
      <option value="朝">朝</option>
      <option value="昼">昼</option>
      <option value="夕">夕</option>
      <option value="間食">間食</option>
      <option value="就寝前">就寝前</option>
    </select>

    <select id="foodSelect" aria-label="食品名"></select>
    <select id="quantity" aria-label="数量"></select>

    <div id="buttonWrap">
      <button onclick="addEntry()">追加</button>
      <button onclick="clearAll()">全削除</button>
    </div>
  </div>

  <h2>記録されたカロリー</h2>
  <table id="entryTable" aria-label="カロリー記録テーブル">
    <thead>
      <tr>
        <th>時間</th><th>食品名</th><th>数量</th><th>カロリー</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="summary-row">
    <h3 id="totalCalories">合計: 0 kcal</h3>
  </div>

  <button id="registerButton" onclick="openRegisterModal()">食品データ登録へ</button>

  <!-- 食品登録モーダル -->
  <div id="registerModal" class="modal" aria-hidden="true" aria-labelledby="registerTitle" role="dialog">
    <div class="modal-content">
      <span class="close" onclick="closeRegisterModal()" aria-label="閉じる">&times;</span>
      <h2 id="registerTitle">食品データ登録</h2>
      <label for="foodNameInput">食品名</label>
      <input type="text" id="foodNameInput" placeholder="例: バナナ" />
      <label for="foodKcalInput">100gあたりのカロリー (kcal)</label>
      <input type="number" id="foodKcalInput" min="0" placeholder="例: 86" />
      <button onclick="addFood()">登録</button>

      <h3>登録済み食品一覧</h3>
      <ul id="foodListDisplay"></ul>
    </div>
  </div>

  <!-- カレンダーモーダル -->
  <div id="calendarModal" class="modal" aria-hidden="true" aria-labelledby="calendarTitle" role="dialog">
    <div class="modal-content">
      <span class="close" onclick="closeCalendarModal()" aria-label="閉じる">&times;</span>
      <h2 id="calendarTitle">カレンダー表示</h2>
      <div>
        <button onclick="prevMonth()">前の月</button>
        <button onclick="nextMonth()">次の月</button>
      </div>
      <div id="calendarDisplay"></div>
    </div>
  </div>

<script>
  // 初期データ、ローカルストレージキー
  const STORAGE_KEY_FOODS = 'customFoods';
  const STORAGE_KEY_ENTRIES = 'entriesByDate';

  // 初期食品データ（選択してくださいはダミー）
  const defaultFoods = [{ name: '選択してください', kcal: 0 }];
  let customFoods = JSON.parse(localStorage.getItem(STORAGE_KEY_FOODS) || '[]');
  let entriesByDate = JSON.parse(localStorage.getItem(STORAGE_KEY_ENTRIES) || '{}');

  // 今日の日付を yyyy-mm-dd 形式で取得
  function getTodayStr() {
    return new Date().toISOString().slice(0,10);
  }

  // 要素取得ショートカット
  const $ = id => document.getElementById(id);

  // 初期化処理
  window.onload = () => {
    setToday();
    loadFoodOptions();
    loadQuantityOptions();
    renderTable();
  };

  // 今日の日付をセット
  function setToday() {
    const today = getTodayStr();
    $('calendarDate').value = today;
  }

  // 食品選択肢をセット
  function loadFoodOptions() {
    const foodSelect = $('foodSelect');
    foodSelect.innerHTML = '';
    [...defaultFoods, ...customFoods].forEach((food, i) => {
      const option = document.createElement('option');
      option.value = food.name;
      option.textContent = food.name;
      option.dataset.kcal = food.kcal;
      if(i === 0) {
        option.disabled = true;
        option.hidden = true;
        option.selected = true;
      }
      foodSelect.appendChild(option);
    });
  }

  // 数量選択肢セット 0.1～10.0まで0.1刻み
  function loadQuantityOptions() {
    const quantitySelect = $('quantity');
    quantitySelect.innerHTML = '';
    for(let i=0.1; i<=10.0; i+=0.1) {
      const val = i.toFixed(1);
      const option = document.createElement('option');
      option.value = val;
      option.textContent = val;
      quantitySelect.appendChild(option);
    }
    quantitySelect.value = '1.0';
  }

  // 選択されている日付を取得
  function getSelectedDate() {
    return $('calendarDate').value;
  }

  // 追加ボタン押下
  function addEntry() {
    const time = $('timeSelect').value;
    const foodSelect = $('foodSelect');
    const foodName = foodSelect.value;
    if(foodName === '選択してください') {
      alert('食品を選択してください');
      return;
    }
    const kcalPer100g = Number(foodSelect.options[foodSelect.selectedIndex].dataset.kcal);
    const quantity = Number($('quantity').value);
    const totalKcal = Math.round(kcalPer100g * quantity);

    const date = getSelectedDate();
    if(!entriesByDate[date]) entriesByDate[date] = [];
    entriesByDate[date].push({ time, name: foodName, quantity, kcal: totalKcal });
    localStorage.setItem(STORAGE_KEY_ENTRIES, JSON.stringify(entriesByDate));
    renderTable();
  }

  // 記録テーブルを描画
  function renderTable() {
    const date = getSelectedDate();
    const tbody = $('entryTable').querySelector('tbody');
    tbody.innerHTML = '';

    const entries = entriesByDate[date] || [];
    if(entries.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">記録なし</td></tr>';
      $('totalCalories').textContent = '合計: 0 kcal';
      return;
    }

    let sum = 0;
    entries.forEach((entry, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${entry.time}</td>
                      <td>${entry.name}</td>
                      <td>${entry.quantity}</td>
                      <td>${entry.kcal}</td>`;
      tbody.appendChild(tr);
      sum += entry.kcal;
    });
    $('totalCalories').textContent = `合計: ${sum} kcal`;
  }

  // 全削除ボタン押下
  function clearAll() {
    const date = getSelectedDate();
    if(confirm(`${date} の記録を削除しますか？`)) {
      delete entriesByDate[date];
      localStorage.setItem(STORAGE_KEY_ENTRIES, JSON.stringify(entriesByDate));
      renderTable();
    }
  }

  // ---- 食品登録モーダル関連 ----
  const registerModal = $('registerModal');
  const foodListDisplay = $('foodListDisplay');

  function openRegisterModal() {
    registerModal.style.display = 'block';
    registerModal.setAttribute('aria-hidden', 'false');
    renderFoodList();
  }
  function closeRegisterModal() {
    registerModal.style.display = 'none';
    registerModal.setAttribute('aria-hidden', 'true');
    $('foodNameInput').value = '';
    $('foodKcalInput').value = '';
  }

  // 食品追加
  function addFood() {
    const name = $('foodNameInput').value.trim();
    const kcal = Number($('foodKcalInput').value);
    if(!name) {
      alert('食品名を入力してください');
      return;
    }
    if(isNaN(kcal) || kcal <= 0) {
      alert('カロリーは正の数で入力してください');
      return;
    }
    if(customFoods.find(f => f.name === name)) {
      alert('同じ名前の食品が既にあります');
      return;
    }
    customFoods.push({ name, kcal });
    localStorage.setItem(STORAGE_KEY_FOODS, JSON.stringify(customFoods));
    loadFoodOptions();
    renderFoodList();
    $('foodNameInput').value = '';
    $('foodKcalInput').value = '';
  }

  // 食品一覧描画
  function renderFoodList() {
    foodListDisplay.innerHTML = '';
    if(customFoods.length === 0) {
      foodListDisplay.innerHTML = '<li>登録済み食品はありません</li>';
      return;
    }
    customFoods.forEach((food, i) => {
      const li = document.createElement('li');
      li.textContent = `${food.name} : ${food.kcal} kcal`;
      const delBtn = document.createElement('button');
      delBtn.textContent = '削除';
      delBtn.onclick = () => {
        if(confirm(`${food.name} を削除しますか？`)) {
          customFoods.splice(i, 1);
          localStorage.setItem(STORAGE_KEY_FOODS, JSON.stringify(customFoods));
          loadFoodOptions();
          renderFoodList();
        }
      };
      li.appendChild(delBtn);
      foodListDisplay.appendChild(li);
    });
  }

  // モーダル閉じる時もリセット
  window.onclick = function(event) {
    if(event.target === registerModal) closeRegisterModal();
    if(event.target === calendarModal) closeCalendarModal();
  }

  // ---- カレンダーモーダル関連 ----
  const calendarModal = $('calendarModal');
  const calendarDisplay = $('calendarDisplay');

  let currentYear, currentMonth; // カレンダー表示年月

  function openCalendarModal() {
    calendarModal.style.display = 'block';
    calendarModal.setAttribute('aria-hidden', 'false');
    const today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth();
    drawCalendar(currentYear, currentMonth);
  }

  function closeCalendarModal() {
    calendarModal.style.display = 'none';
    calendarModal.setAttribute('aria-hidden', 'true');
    calendarDisplay.innerHTML = '';
  }

  function prevMonth() {
    currentMonth--;
    if(currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    drawCalendar(currentYear, currentMonth);
  }
  function nextMonth() {
    currentMonth++;
    if(currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    drawCalendar(currentYear, currentMonth);
  }

  // 曜日ヘッダー
  const weekDays = ['日','月','火','水','木','金','土'];

  function drawCalendar(year, month) {
    calendarDisplay.innerHTML = '';
    // 曜日ヘッダー
    weekDays.forEach(day => {
      const hd = document.createElement('div');
      hd.textContent = day;
      hd.className = 'header';
      calendarDisplay.appendChild(hd);
    });

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month +1, 0);
    const firstWeekday = firstDay.getDay();
    const lastDate = lastDay.getDate();

    // 空セルを埋める（前月の余白）
    for(let i=0; i<firstWeekday; i++) {
      const empty = document.createElement('div');
      empty.className = 'empty-cell';
      calendarDisplay.appendChild(empty);
    }

    const todayStr = getTodayStr();

    // 日付セル作成
    for(let day=1; day<=lastDate; day++) {
      const cell = document.createElement('div');
      cell.className = 'date-cell';
      const ymd = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      cell.textContent = day;

      // 今日の場合は強調
      if(ymd === todayStr) {
        cell.classList.add('today');
      }

      // その日のカロリー合計があれば表示
      const entries = entriesByDate[ymd];
      if(entries && entries.length > 0) {
        const sum = entries.reduce((a,v) => a + v.kcal, 0);
        cell.setAttribute('data-kcal', sum);
        cell.classList.add('has-entry');
      }

      // クリックしたら日付をカレンダーにセットしモーダル閉じる
      cell.onclick = () => {
        $('calendarDate').value = ymd;
        closeCalendarModal();
        renderTable();
      };

      calendarDisplay.appendChild(cell);
    }

    // 空セル（次月分）も埋める（見た目整える）
    const totalCells = firstWeekday + lastDate;
    const nextEmpty = (7 - (totalCells % 7)) % 7;
    for(let i=0; i<nextEmpty; i++) {
      const empty = document.createElement('div');
      empty.className = 'empty-cell';
      calendarDisplay.appendChild(empty);
    }
  }

  // 日付変更でテーブル再描画
  $('calendarDate').addEventListener('change', () => {
    renderTable();
  });

</script>
</body>
</html>
