<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>摂取カロリー記録</title>
  <style>
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
      color: #333;
    }
    h1 {
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 1.8em;
    }
    /* タイトルとカレンダー表示ボタンを縦並びに */
    .title-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    #openCalendarBtn {
      margin-top: 6px;
      padding: 6px 14px;
      font-size: 0.9em;
      cursor: pointer;
      background-color: #48a9e6;
      border: none;
      border-radius: 6px;
      color: white;
      transition: background-color 0.3s;
    }
    #openCalendarBtn:hover {
      background-color: #357ab8;
    }

    /* 入力フォーム：2列2行のグリッド */
    #inputForm {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      grid-row-gap: 12px;
      grid-column-gap: 10px;
      align-items: center;
      margin-bottom: 15px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    /* ラベルは右寄せ・入力は左寄せ */
    #inputForm label {
      text-align: right;
      padding-right: 6px;
      font-weight: 600;
      font-size: 0.9em;
      user-select: none;
    }
    #inputForm input[type="date"],
    #inputForm select {
      padding: 6px 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    #addEntryBtn {
      grid-column: 3 / 5;
      justify-self: right;
      padding: 8px 18px;
      font-size: 1em;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #addEntryBtn:hover {
      background-color: #3a8d40;
    }

    /* 記録テーブル */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 12px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: center;
      font-size: 0.95em;
    }
    th {
      background-color: #48a9e6;
      color: white;
      font-weight: 600;
    }
    #totalCalories {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 20px;
      color: #333;
    }

    /* ボタン2つを左右に配置 */
    .button-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    #clearAllBtn {
      background-color: #e84a5f;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #clearAllBtn:hover {
      background-color: #b83043;
    }
    #openRegisterBtn {
      background-color: #ff7f50;
      color: white;
      border: none;
      border-radius: 22px;
      padding: 10px 22px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(255, 127, 80, 0.5);
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    #openRegisterBtn:hover {
      background-color: #e05f32;
      box-shadow: 0 6px 10px rgba(224, 95, 50, 0.8);
    }

    /* モーダル共通 */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
    }
    .modal-content {
      background-color: white;
      margin: 40px auto;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      position: relative;
    }
    .close {
      position: absolute;
      top: 10px; right: 14px;
      font-size: 24px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      user-select: none;
    }
    .close:hover {
      color: #333;
    }

    /* カレンダー表示 */
    #calendarDisplay {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 12px;
      user-select: none;
    }
    #calendarDisplay .header {
      font-weight: 600;
      text-align: center;
      padding: 6px 0;
      background-color: #48a9e6;
      color: white;
      border-radius: 6px;
      font-size: 0.9em;
    }
    #calendarDisplay .date-cell {
      background: #e0f0ff;
      border-radius: 6px;
      padding: 6px 0;
      text-align: center;
      cursor: pointer;
      font-size: 0.9em;
      position: relative;
      transition: background-color 0.2s;
    }
    #calendarDisplay .date-cell.today {
      background-color: #4caf50;
      color: white;
      font-weight: bold;
    }
    #calendarDisplay .date-cell.has-entry::after {
      content: attr(data-kcal) " kcal";
      position: absolute;
      bottom: 4px;
      right: 4px;
      font-size: 0.75em;
      color: #333;
      font-weight: 600;
      background: #fff9c4;
      border-radius: 3px;
      padding: 1px 4px;
      box-shadow: 0 0 2px rgba(0,0,0,0.2);
    }
    #calendarDisplay .date-cell:hover {
      background-color: #99d3ff;
    }
    #calendarDisplay .empty-cell {
      background: transparent;
      pointer-events: none;
    }

    /* フォードデータ登録モーダルのスタイル */
    #registerModal label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
      user-select: none;
    }
    #registerModal input[type="text"],
    #registerModal input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      box-sizing: border-box;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #registerModal button {
      margin-top: 16px;
      width: 100%;
      padding: 10px;
      font-size: 1.1em;
      background-color: #ff7f50;
      border: none;
      border-radius: 22px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 3px 6px rgba(255, 127, 80, 0.5);
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    #registerModal button:hover {
      background-color: #e05f32;
      box-shadow: 0 6px 10px rgba(224, 95, 50, 0.8);
    }
    #foodListDisplay li {
      margin-top: 8px;
      font-size: 0.95em;
      list-style: none;
      padding: 4px 0;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #foodListDisplay button {
      background-color: #e84a5f;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s;
    }
    #foodListDisplay button:hover {
      background-color: #b83043;
    }

    /* レスポンシブ調整 */
    @media (max-width: 480px) {
      #inputForm {
        grid-template-columns: auto 1fr;
      }
      #addEntryBtn {
        grid-column: 1 / 3;
        justify-self: center;
      }
      .button-row {
        flex-direction: column;
        gap: 10px;
      }
      #clearAllBtn, #openRegisterBtn {
        width: 100%;
      }
      .title-container {
        align-items: center;
      }
    }
  </style>
</head>
<body>

  <div class="title-container">
    <h1>摂取カロリー記録</h1>
    <button id="openCalendarBtn" aria-haspopup="dialog" aria-controls="calendarModal" onclick="openCalendarModal()">カレンダー表示</button>
  </div>

  <!-- 入力フォーム -->
  <div id="inputForm" role="form" aria-label="摂取記録入力フォーム">
    <label for="calendarDate">日付：</label>
    <input type="date" id="calendarDate" />
    <label for="timeSelect">時間：</label>
    <select id="timeSelect" aria-label="時間帯選択">
      <option value="朝">朝</option>
      <option value="昼">昼</option>
      <option value="夜">夜</option>
      <option value="間食">間食</option>
    </select>
    <label for="foodSelect">食品名：</label>
    <select id="foodSelect" aria-label="食品選択"></select>
    <label for="quantity">数量：</label>
    <select id="quantity" aria-label="数量選択"></select>
    <button id="addEntryBtn" onclick="addEntry()" aria-label="摂取記録を追加">追加</button>
  </div>

  <!-- 記録テーブル -->
  <table aria-label="摂取記録一覧" id="entryTable">
    <thead>
      <tr>
        <th>時間帯</th><th>食品名</th><th>数量</th><th>カロリー(kcal)</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="4" style="text-align:center; color:#888;">記録なし</td></tr>
    </tbody>
  </table>

  <div id="totalCalories">合計: 0 kcal</div>

  <div class="button-row">
    <button id="clearAllBtn" onclick="clearAll()">全削除</button>
    <button id="openRegisterBtn" onclick="openRegisterModal()">食品データ登録へ</button>
  </div>

  <!-- 食品登録モーダル -->
  <div id="registerModal" class="modal" aria-hidden="true" aria-labelledby="registerTitle" role="dialog">
    <div class="modal-content">
      <span class="close" onclick="closeRegisterModal()" aria-label="閉じる">&times;</span>
      <h2 id="registerTitle">食品データ登録</h2>
      <label for="foodNameInput">食品名</label>
      <input type="text" id="foodNameInput" placeholder="例: バナナ" />
      <label for="foodKcalInput">100gあたりのカロリー (kcal)</label>
      <input type="number" id="foodKcalInput" min="0" placeholder="例: 86" />
      <button onclick="addFood()">登録</button>

      <h3>登録済み食品一覧</h3>
      <ul id="foodListDisplay"></ul>
    </div>
  </div>

  <!-- カレンダーモーダル -->
  <div id="calendarModal" class="modal" aria-hidden="true" aria-labelledby="calendarTitle" role="dialog">
    <div class="modal-content">
      <span class="close" onclick="closeCalendarModal()" aria-label="閉じる">&times;</span>
      <h2 id="calendarTitle">カレンダー表示</h2>
      <div>
        <button onclick="prevMonth()">前の月</button>
        <button onclick="nextMonth()">次の月</button>
      </div>
      <div id="calendarDisplay"></div>
    </div>
  </div>

<script>
  const STORAGE_KEY_FOODS = 'customFoods';
  const STORAGE_KEY_ENTRIES = 'entriesByDate';

  const defaultFoods = [{ name: '選択してください', kcal: 0 }];
  let customFoods = JSON.parse(localStorage.getItem(STORAGE_KEY_FOODS) || '[]');
  let entriesByDate = JSON.parse(localStorage.getItem(STORAGE_KEY_ENTRIES) || '{}');

  const $ = id => document.getElementById(id);

  function getTodayStr() {
    return new Date().toISOString().slice(0,10);
  }

  window.onload = () => {
    setToday();
    loadFoodOptions();
    loadQuantityOptions();
    renderTable();
  };

  function setToday() {
    $('calendarDate').value = getTodayStr();
  }

  function loadFoodOptions() {
    const foodSelect = $('foodSelect');
    foodSelect.innerHTML = '';
    [...defaultFoods, ...customFoods].forEach((food, i) => {
      const option = document.createElement('option');
      option.value = food.name;
      option.textContent = food.name;
      option.dataset.kcal = food.kcal;
      if(i === 0) {
        option.disabled = true;
        option.hidden = true;
        option.selected = true;
      }
      foodSelect.appendChild(option);
    });
  }

  function loadQuantityOptions() {
    const quantity = $('quantity');
    quantity.innerHTML = '';
    for(let i = 1; i <= 10; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i + '個';
      quantity.appendChild(opt);
    }
  }

  function addEntry() {
    const date = $('calendarDate').value;
    const time = $('timeSelect').value;
    const foodName = $('foodSelect').value;
    const quantity = parseInt($('quantity').value, 10);
    if (!date) {
      alert('日付を選択してください。');
      return;
    }
    if (foodName === defaultFoods[0].name) {
      alert('食品を選択してください。');
      return;
    }
    if (quantity < 1) {
      alert('数量を選択してください。');
      return;
    }
    const food = [...defaultFoods, ...customFoods].find(f => f.name === foodName);
    if (!food) {
      alert('食品データが見つかりません。');
      return;
    }
    const kcal = Math.round(food.kcal * quantity);

    if (!entriesByDate[date]) entriesByDate[date] = [];
    entriesByDate[date].push({ time, foodName, quantity, kcal });
    localStorage.setItem(STORAGE_KEY_ENTRIES, JSON.stringify(entriesByDate));
    renderTable();
  }

  function renderTable() {
    const date = $('calendarDate').value || getTodayStr();
    const tbody = $('entryTable').querySelector('tbody');
    tbody.innerHTML = '';

    if (!entriesByDate[date] || entriesByDate[date].length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.textContent = '記録なし';
      td.style.color = '#888';
      td.style.textAlign = 'center';
      tr.appendChild(td);
      tbody.appendChild(tr);
      $('totalCalories').textContent = '合計: 0 kcal';
      return;
    }

    let total = 0;
    entriesByDate[date].forEach(entry => {
      const tr = document.createElement('tr');
      ['time', 'foodName', 'quantity', 'kcal'].forEach(key => {
        const td = document.createElement('td');
        td.textContent = entry[key];
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
      total += entry.kcal;
    });
    $('totalCalories').textContent = `合計: ${total} kcal`;
  }

  // --- 食品登録モーダル ---
  function openRegisterModal() {
    $('registerModal').style.display = 'block';
    $('registerModal').setAttribute('aria-hidden', 'false');
    renderFoodList();
  }
  function closeRegisterModal() {
    $('registerModal').style.display = 'none';
    $('registerModal').setAttribute('aria-hidden', 'true');
  }

  function addFood() {
    const name = $('foodNameInput').value.trim();
    const kcal = parseFloat($('foodKcalInput').value);
    if (!name) {
      alert('食品名を入力してください。');
      return;
    }
    if (isNaN(kcal) || kcal <= 0) {
      alert('カロリーは0より大きい数値を入力してください。');
      return;
    }
    if (customFoods.find(f => f.name === name)) {
      alert('すでに同じ名前の食品が登録されています。');
      return;
    }
    customFoods.push({ name, kcal });
    localStorage.setItem(STORAGE_KEY_FOODS, JSON.stringify(customFoods));
    $('foodNameInput').value = '';
    $('foodKcalInput').value = '';
    loadFoodOptions();
    renderFoodList();
  }

  function renderFoodList() {
    const list = $('foodListDisplay');
    list.innerHTML = '';
    if(customFoods.length === 0) {
      const li = document.createElement('li');
      li.textContent = '登録された食品はありません。';
      list.appendChild(li);
      return;
    }
    customFoods.forEach((food, i) => {
      const li = document.createElement('li');
      li.textContent = `${food.name} - ${food.kcal} kcal/100g`;
      const delBtn = document.createElement('button');
      delBtn.textContent = '削除';
      delBtn.setAttribute('aria-label', `食品${food.name}を削除`);
      delBtn.onclick = () => {
        if(confirm(`食品「${food.name}」を削除しますか？`)) {
          customFoods.splice(i, 1);
          localStorage.setItem(STORAGE_KEY_FOODS, JSON.stringify(customFoods));
          loadFoodOptions();
          renderFoodList();
        }
      };
      li.appendChild(delBtn);
      list.appendChild(li);
    });
  }

  // --- カレンダーモーダル ---
  let calendarYear, calendarMonth;

  function openCalendarModal() {
    const modal = $('calendarModal');
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    const today = new Date();
    calendarYear = today.getFullYear();
    calendarMonth = today.getMonth();
    renderCalendar();
  }
  function closeCalendarModal() {
    const modal = $('calendarModal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }

  function renderCalendar() {
    const calendar = $('calendarDisplay');
    calendar.innerHTML = '';

    // 曜日ヘッダー
    const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
    weekdays.forEach(day => {
      const div = document.createElement('div');
      div.textContent = day;
      div.className = 'header';
      calendar.appendChild(div);
    });

    const firstDay = new Date(calendarYear, calendarMonth, 1);
    const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
    const firstWeekday = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    // 空白セル
    for(let i=0; i < firstWeekday; i++) {
      const empty = document.createElement('div');
      empty.className = 'empty-cell';
      calendar.appendChild(empty);
    }

    // 各日のセル
    for(let day=1; day <= daysInMonth; day++) {
      const cell = document.createElement('div');
      cell.className = 'date-cell';

      const dateStr = `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

      // 今日判定
      const todayStr = getTodayStr();
      if(dateStr === todayStr) {
        cell.classList.add('today');
      }

      // カロリー合計取得
      let totalKcal = 0;
      if(entriesByDate[dateStr]) {
        totalKcal = entriesByDate[dateStr].reduce((sum, e) => sum + e.kcal, 0);
      }
      if(totalKcal > 0) {
        cell.classList.add('has-entry');
        cell.setAttribute('data-kcal', totalKcal);
      }
      cell.textContent = day;

      // 日付クリック時に選択
      cell.tabIndex = 0;
      cell.setAttribute('role', 'button');
      cell.setAttribute('aria-label', `${day}日、合計${totalKcal}kcal`);
      cell.addEventListener('click', () => {
        $('calendarDate').value = dateStr;
        renderTable();
        closeCalendarModal();
      });
      cell.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          cell.click();
        }
      });

      calendar.appendChild(cell);
    }
  }

  function prevMonth() {
    calendarMonth--;
    if(calendarMonth < 0) {
      calendarMonth = 11;
      calendarYear--;
    }
    renderCalendar();
  }

  function nextMonth() {
    calendarMonth++;
    if(calendarMonth > 11) {
      calendarMonth = 0;
      calendarYear++;
    }
    renderCalendar();
  }

  // 全削除
  function clearAll() {
    if(confirm('すべての摂取記録を削除しますか？')) {
      entriesByDate = {};
      localStorage.setItem(STORAGE_KEY_ENTRIES, JSON.stringify(entriesByDate));
      renderTable();
    }
  }

  // 日付が変わったらテーブルを更新
  $('calendarDate').addEventListener('change', renderTable);

  // 時間帯、食品、数量変更は特に即時処理なし

</script>

</body>
</html>
