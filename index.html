<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>摂取カロリー記録</title>
<style>
  /* フォントサイズ全体を少し小さく */
  body {
    font-family: 'Arial', sans-serif;
    font-size: 14px; /* 元は16pxくらい想定なので一回り小さく */
    margin: 20px;
    background: #fff0f0;
    color: #800000;
  }
  h1 {
    text-align: center;
    margin-bottom: 40px;
    font-weight: bold;
    font-size: 1.6rem;
    position: relative;
  }
  /* カレンダーボタンはタイトル右下に */
  #calendarOpenBtn {
    position: absolute;
    right: 10px;
    top: 40px;
    background-color: #ff6666;
    border: none;
    color: white;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
  }
  #calendarOpenBtn:hover {
    background-color: #ff4d4d;
  }

  /* 入力フォーム全体 */
  .form-row {
    display: flex;
    gap: 12px;
    margin-bottom: 8px;
    align-items: center;
  }
  .form-label {
    min-width: 60px;
    color: #cc0033;
    font-weight: 600;
  }
  input[type="date"],
  select,
  input[type="number"] {
    flex-grow: 1;
    padding: 4px 6px;
    border: 1.5px solid #ff9999;
    border-radius: 5px;
    font-size: 0.95rem;
  }
  select:invalid {
    color: #999999;
  }

  /* ボタン群 */
  .button-row {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
  }
  button {
    flex-grow: 1;
    background-color: #ff8080;
    border: none;
    color: white;
    padding: 8px 0;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s;
  }
  button:hover:not(:disabled) {
    background-color: #ff4d4d;
  }
  button:disabled {
    background-color: #f0baba;
    cursor: default;
  }

  /* テーブル */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 6px;
    font-size: 0.9rem;
  }
  th, td {
    border: 1px solid #ff9999;
    padding: 6px 8px;
    text-align: center;
    color: #800000;
  }
  th {
    background-color: #ffd6d6;
  }

  /* 合計カロリー表示をテーブル右下に */
  #totalCalories {
    text-align: right;
    font-weight: 700;
    color: #cc0000;
    font-size: 1rem;
    margin-top: -6px;
    margin-bottom: 20px;
  }

  /* カレンダーモーダル */
  #calendarModal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0; right: 0; bottom: 0;
    background: rgba(255, 200, 200, 0.9);
    overflow: auto;
    padding: 20px;
  }
  #calendarContent {
    background: white;
    max-width: 320px;
    margin: 50px auto;
    padding: 12px;
    border-radius: 10px;
  }
  #calendarGrid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    text-align: center;
  }
  #calendarGrid > div {
    padding: 6px 0;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
  }
  #calendarGrid > div:hover,
  #calendarGrid > div:focus {
    background-color: #ffcccc;
    outline: none;
  }
  #calendarGrid .empty {
    cursor: default;
    background: transparent;
  }
  .kcalLabel {
    font-size: 0.7rem;
    color: #cc3333;
    position: absolute;
    right: 4px;
    bottom: 2px;
    font-weight: 700;
  }
  #calendarCloseBtn {
    margin-top: 12px;
    padding: 6px 14px;
    background-color: #ff6666;
    border: none;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }
  #calendarCloseBtn:hover {
    background-color: #ff4d4d;
  }
  /* 選択していない食品名の色を灰色に */
  select:invalid {
    color: #999999;
  }

</style>
</head>
<body>
  <h1>
    摂取カロリー記録
    <button id="calendarOpenBtn" aria-haspopup="dialog" aria-expanded="false" aria-controls="calendarModal">カレンダー</button>
  </h1>

  <form id="inputForm" onsubmit="return false;">
    <div class="form-row">
      <label for="calendarDate" class="form-label">日付：</label>
      <input type="date" id="calendarDate" required />
      <label for="timeSelect" class="form-label">時間：</label>
      <select id="timeSelect" required>
        <option value="朝">朝</option>
        <option value="昼">昼</option>
        <option value="夕">夕</option>
　　　　<option value="就寝前">就寝前</option>
        <option value="間食">間食</option>
      </select>
    </div>
    <div class="form-row">
      <label for="foodSelect" class="form-label">食品名：</label>
      <select id="foodSelect" required>
        <option value="" disabled selected>選択してください</option>
      </select>
      <label for="quantitySelect" class="form-label">数量：</label>
      <select id="quantitySelect" required>
        <!-- 数量1~10 -->
      </select>
    </div>
    <div class="button-row">
      <button id="addEntryBtn" type="button" disabled>追加</button>
      <button id="clearAllBtn" type="button">全削除</button>
      <button id="openRegisterBtn" type="button">食品データ登録</button>
    </div>
  </form>

  <table aria-label="摂取記録一覧">
    <thead>
      <tr>
        <th>時間帯</th>
        <th>食品名</th>
        <th>数量</th>
        <th>カロリー</th>
      </tr>
    </thead>
    <tbody id="entryTableBody"></tbody>
  </table>

  <div id="totalCalories" aria-live="polite" aria-atomic="true">合計: 0 kcal</div>

  <!-- カレンダーモーダル -->
  <div id="calendarModal" role="dialog" aria-modal="true" aria-labelledby="calendarTitle" aria-hidden="true">
    <div id="calendarContent">
      <h2 id="calendarTitle" style="text-align:center; margin-top:0; color:#cc0033;">カレンダー</h2>
      <div id="calendarGrid" tabindex="0"></div>
      <button id="calendarCloseBtn">閉じる</button>
    </div>
  </div>

  <!-- 食品登録モーダル -->
  <div id="registerModal" role="dialog" aria-modal="true" aria-labelledby="registerTitle" aria-hidden="true" style="display:none; position:fixed; z-index:1100; left:0;top:0;right:0;bottom:0; background: rgba(255, 200, 200, 0.9); overflow:auto;">
    <div style="background:#fff; max-width:320px; margin:50px auto; padding:16px; border-radius:10px;">
      <h2 id="registerTitle" style="color:#cc0033; margin-top:0;">食品データ登録</h2>
      <label for="newFoodName" style="display:block; margin-bottom:6px;">食品名：</label>
      <input type="text" id="newFoodName" style="width:100%; padding:6px; border:1.5px solid #ff9999; border-radius:6px; margin-bottom:10px;" />
      <label for="newFoodCalories" style="display:block; margin-bottom:6px;">カロリー(kcal)：</label>
      <input type="number" id="newFoodCalories" min="1" style="width:100%; padding:6px; border:1.5px solid #ff9999; border-radius:6px; margin-bottom:10px;" />
      <button id="addFoodItemBtn" style="background:#ff6666; color:#fff; border:none; padding:8px; border-radius:8px; width:100%; font-weight:600; cursor:pointer;">登録</button>
      <button id="registerCloseBtn" style="margin-top:10px; background:#ff4d4d; color:#fff; border:none; padding:6px; border-radius:6px; width:100%; font-weight:600; cursor:pointer;">閉じる</button>
      <ul id="foodListDisplay" style="margin-top:10px; color:#cc0033; font-size:0.85rem;"></ul>
      <ul id="foodListDisplay" style="margin-top:10px; color:#cc0033; font-size:0.85rem;"></ul>
<button id="deleteSelectedFoodsBtn" style="background:#cc0000; color:#fff; border:none; padding:8px; border-radius:8px; width:100%; font-weight:600; cursor:pointer; margin-top:8px;">選択した食品を削除</button>

    </div>
  </div>

<script>
(() => {
  // DOM要素取得
  const calendarOpenBtn = document.getElementById('calendarOpenBtn');
  const calendarModal = document.getElementById('calendarModal');
  const calendarCloseBtn = document.getElementById('calendarCloseBtn');
  const calendarDate = document.getElementById('calendarDate');
  const timeSelect = document.getElementById('timeSelect');
  const foodSelect = document.getElementById('foodSelect');
  const quantitySelect = document.getElementById('quantitySelect');
  const addEntryBtn = document.getElementById('addEntryBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');
  const openRegisterBtn = document.getElementById('openRegisterBtn');
  const entryTableBody = document.getElementById('entryTableBody');
  const totalCalories = document.getElementById('totalCalories');
  const registerModal = document.getElementById('registerModal');
  const registerCloseBtn = document.getElementById('registerCloseBtn');
  const addFoodItemBtn = document.getElementById('addFoodItemBtn');
  const newFoodName = document.getElementById('newFoodName');
  const newFoodCalories = document.getElementById('newFoodCalories');
  const foodListDisplay = document.getElementById('foodListDisplay');

  // 保存データ
  let entriesByDate = JSON.parse(localStorage.getItem('entriesByDate') || '{}');
  let customFoods = JSON.parse(localStorage.getItem('customFoods') || '[]');

  // 予め用意した食品（例）
  const predefinedFoods = [
    { name: '', kcal: 0 },
  ];

  // 今日の日付を初期値セット
  function formatDateToInput(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  calendarDate.value = formatDateToInput(new Date());

  // 数量セレクトに1~10までをセット
function initQuantityOptions() {
  quantitySelect.innerHTML = '';
  for (let i = 1; i <= 100; i++) {
    const value = (i * 0.1).toFixed(1);  // 0.1, 0.2, ..., 10.0
    const opt = document.createElement('option');
    opt.value = value;
    opt.textContent = value;
    quantitySelect.appendChild(opt);
  }
}
initQuantityOptions();
  // 食品セレクトを更新（プリセット＋カスタム）
  function updateFoodSelect() {
    const prevVal = foodSelect.value;
    foodSelect.innerHTML = '';
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.disabled = true;
    defaultOpt.selected = true;
    defaultOpt.textContent = '選択してください';
    foodSelect.appendChild(defaultOpt);
    const allFoods = [...customFoods];
    allFoods.forEach(f => {
      const opt = document.createElement('option');
      opt.value = f.name;
      opt.textContent = f.name;
      foodSelect.appendChild(opt);
    });
    if ([...foodSelect.options].some(o => o.value === prevVal)) {
      foodSelect.value = prevVal;
    }
    checkAddButtonState();
  }
  updateFoodSelect();

  // 追加ボタン活性判定（食品名選択必須）
  function checkAddButtonState() {
    addEntryBtn.disabled = foodSelect.value === '';
  }
  foodSelect.addEventListener('change', checkAddButtonState);

  // 登録データ表示更新
  function updateEntryTable() {
    const dateKey = calendarDate.value;
    entryTableBody.innerHTML = '';
    if (!entriesByDate[dateKey]) {
      totalCalories.textContent = '合計: 0 kcal';
      return;
    }
    let total = 0;
    entriesByDate[dateKey].forEach(({ time, food, quantity, kcal }) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${time}</td><td>${food}</td><td>${quantity}</td><td>${kcal * quantity}</td>`;
      entryTableBody.appendChild(tr);
      total += kcal * quantity;
    });
    totalCalories.textContent = `合計: ${total} kcal`;
  }

  // データ保存
  function saveEntries() {
    localStorage.setItem('entriesByDate', JSON.stringify(entriesByDate));
  }
  function saveCustomFoods() {
    localStorage.setItem('customFoods', JSON.stringify(customFoods));
  }

  // 追加ボタン処理
  addEntryBtn.addEventListener('click', () => {
    const dateKey = calendarDate.value;
    const time = timeSelect.value;
    const foodName = foodSelect.value;
    const quantity = parseFloat(quantitySelect.value);
    if (!dateKey || !time || !foodName || !quantity) return;
 
    // kcal取得
    let kcal = 0;
    const allFoods = [...predefinedFoods, ...customFoods];
    const foodData = allFoods.find(f => f.name === foodName);
    if (!foodData) return;
    kcal = foodData.kcal;

    if (!entriesByDate[dateKey]) entriesByDate[dateKey] = [];
    entriesByDate[dateKey].push({ time, food: foodName, quantity, kcal });
    saveEntries();
    updateEntryTable();
  });

  // 全削除ボタン処理
  clearAllBtn.addEventListener('click', () => {
    if (!calendarDate.value) return;
    if (confirm('本当に全て削除しますか？')) {
      delete entriesByDate[calendarDate.value];
      saveEntries();
      updateEntryTable();
    }
  });

  // 日付変更時にテーブル更新
  calendarDate.addEventListener('change', () => {
    updateEntryTable();
  });

  // 最初の表示更新
  updateEntryTable();

  // カレンダー開閉
  calendarOpenBtn.addEventListener('click', () => {
    calendarModal.style.display = 'block';
    calendarModal.setAttribute('aria-hidden', 'false');
    calendarOpenBtn.setAttribute('aria-expanded', 'true');
    buildCalendar(calendarDate.value);
  });
  calendarCloseBtn.addEventListener('click', () => {
    calendarModal.style.display = 'none';
    calendarModal.setAttribute('aria-hidden', 'true');
    calendarOpenBtn.setAttribute('aria-expanded', 'false');
  });

  // カレンダー構築
  function buildCalendar(dateStr) {
    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';
    const dateObj = new Date(dateStr);
    const year = dateObj.getFullYear();
    const month = dateObj.getMonth();

    // 曜日見出し
    ['日','月','火','水','木','金','土'].forEach(d => {
      const dEl = document.createElement('div');
      dEl.textContent = d;
      dEl.style.fontWeight = 'bold';
      calendarGrid.appendChild(dEl);
    });

    // 月初め曜日
    const firstDay = new Date(year, month, 1);
    const startDay = firstDay.getDay();

    // 月末日
    const lastDate = new Date(year, month+1, 0).getDate();

    // 空白セル
    for (let i=0; i<startDay; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.classList.add('empty');
      calendarGrid.appendChild(emptyCell);
    }

    // 日付セル生成
    for (let d=1; d<=lastDate; d++) {
      const dayCell = document.createElement('div');
      dayCell.tabIndex = 0;
      dayCell.style.position = 'relative';
      dayCell.style.border = '1px solid #ff9999';
      dayCell.style.borderRadius = '6px';

      const isToday = (year === new Date().getFullYear() &&
                      month === new Date().getMonth() &&
                      d === new Date().getDate());
      if (isToday) {
        dayCell.style.backgroundColor = '#ffcccc';
        dayCell.style.fontWeight = '700';
      }

      dayCell.textContent = d;

      // その日の日付文字列
      const dayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      // カロリー合計計算
      let dayTotal = 0;
      if (entriesByDate[dayStr]) {
        entriesByDate[dayStr].forEach(e => { dayTotal += e.kcal * e.quantity; });
      }
      if (dayTotal > 0) {
        const kcalLabel = document.createElement('div');
        kcalLabel.className = 'kcalLabel';
        kcalLabel.textContent = `${dayTotal}kcal`;
        dayCell.appendChild(kcalLabel);
      }
      dayCell.addEventListener('click', () => {
        calendarDate.value = dayStr;
        updateEntryTable();
        calendarModal.style.display = 'none';
        calendarModal.setAttribute('aria-hidden', 'true');
        calendarOpenBtn.setAttribute('aria-expanded', 'false');
      });

      calendarGrid.appendChild(dayCell);
    }
  }

  // 食品登録モーダル開閉
  openRegisterBtn.addEventListener('click', () => {
    registerModal.style.display = 'block';
    registerModal.setAttribute('aria-hidden', 'false');
    newFoodName.value = '';
    newFoodCalories.value = '';
    updateFoodListDisplay();
  });
  registerCloseBtn.addEventListener('click', () => {
    registerModal.style.display = 'none';
    registerModal.setAttribute('aria-hidden', 'true');
  });

  // 食品登録リスト表示
function updateFoodListDisplay() {
  foodListDisplay.innerHTML = '';
  if (customFoods.length === 0) {
    foodListDisplay.textContent = '登録された食品はありません。';
    return;
  }
  customFoods.forEach((f, i) => {
    const li = document.createElement('li');
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.gap = '8px';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.dataset.index = i;

    const label = document.createElement('label');
    label.textContent = `${f.name} : ${f.kcal} kcal`;

    li.appendChild(checkbox);
    li.appendChild(label);
    foodListDisplay.appendChild(li);
  });
}
const deleteSelectedFoodsBtn = document.getElementById('deleteSelectedFoodsBtn');

deleteSelectedFoodsBtn.addEventListener('click', () => {
  // チェックされたインデックスを集める
  const checkboxes = foodListDisplay.querySelectorAll('input[type="checkbox"]:checked');
  if (checkboxes.length === 0) {
    alert('削除する食品を選択してください。');
    return;
  }
  if (!confirm('選択した食品を削除しますか？')) {
    return;
  }

  // 選択されたインデックスを逆順にして削除（配列のindex崩れ防止）
  const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index, 10)).sort((a,b) => b - a);
  indices.forEach(i => {
    customFoods.splice(i, 1);
  });

  saveCustomFoods();
  updateFoodSelect();
  updateFoodListDisplay();
});

  // 食品追加登録
  addFoodItemBtn.addEventListener('click', () => {
    const name = newFoodName.value.trim();
    const kcal = parseInt(newFoodCalories.value, 10);
    if (!name || isNaN(kcal) || kcal <= 0) {
      alert('正しい食品名とカロリーを入力してください。');
      return;
    }
    if (customFoods.find(f => f.name === name)) {
      alert('既に同じ名前の食品が登録されています。');
      return;
    }
    customFoods.push({ name, kcal });
    saveCustomFoods();
    updateFoodSelect();
    updateFoodListDisplay();

    newFoodName.value = '';
    newFoodCalories.value = '';
    newFoodName.focus();
  });

})();
</script>
</body>
</html>
